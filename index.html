<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Navi App</title>
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; overflow: hidden; background: #f0f0f0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* 三点リーダーボタン */
        .menu-trigger {
            position: absolute; top: 15px; right: 15px; z-index: 100;
            background: white; width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 24px;
        }

        /* サイドパネルメニュー */
        .side-menu {
            position: absolute; top: 0; right: -280px; width: 250px; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 90;
            transition: 0.3s; padding: 80px 15px 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px;
            overflow-y: auto;
        }
        .side-menu.open { right: 0; }

        /* ナビ情報パネル */
        .nav-info {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 50; background: rgba(0,0,0,0.7); color: white;
            padding: 12px 25px; border-radius: 30px; font-weight: bold;
            display: none; text-align: center; pointer-events: none;
        }

        button {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            background: white; font-size: 14px; font-weight: bold; cursor: pointer;
        }
        button.active { background: #ff4444; color: white; border-color: #ff4444; }
        .section-title { font-size: 12px; color: #666; margin-top: 10px; font-weight: bold; }
        
        #route-list { margin-top: 5px; }
        .route-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee; font-size: 13px;
        }
    </style>
</head>
<body>

<!-- 三点リーダーボタン -->
<div class="menu-trigger" onclick="toggleMenu()">⋮</div>

<!-- サイドメニュー -->
<div id="side-menu" class="side-menu">
    <div class="section-title">ナビ・追従</div>
    <button id="trackBtn" onclick="toggleTracking()">追従モード: OFF</button>
    
    <div class="section-title">ルート作成</div>
    <button id="drawModeBtn" onclick="toggleMode('draw')">なぞって作成</button>
    <button id="autoModeBtn" onclick="toggleMode('auto')">自動ルート作成</button>
    <button onclick="saveCurrentRoute()" style="background: #e3f2fd;">今のルートを保存</button>
    
    <div class="section-title">外部連携・その他</div>
    <button onclick="openGoogleMaps()">Googleマップで開く</button>
    <button onclick="clearMap()" style="color: red;">全てクリア</button>

    <div class="section-title">保存済みルート</div>
    <div id="route-list"></div>
</div>

<!-- 距離表示 -->
<div id="nav-info" class="nav-info">
    目的地まで あと <span id="distance">-</span>
</div>

<div id="map"></div>

<script>
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: { 'osm': { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256, attribution: '© OSM' } },
            layers: [{ id: 'osm-layer', type: 'raster', source: 'osm' }]
        },
        center: [139.767, 35.681],
        zoom: 14
    });

    let isTracking = false;
    let watchId = null;
    let currentRoute = [];
    let mode = 'none';

    map.on('load', () => {
        // ルート表示用レイヤー
        map.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [] } } });
        map.addLayer({ id: 'route-layer', type: 'line', source: 'route', paint: { 'line-color': '#ff4444', 'line-width': 6, 'line-opacity': 0.7 } });

        // 現在地（プライバシー配慮：円で表示）用のソース
        map.addSource('user-pos', { type: 'geojson', data: { type: 'Point', coordinates: [] } });
        map.addLayer({
            id: 'user-area',
            type: 'circle',
            source: 'user-pos',
            paint: {
                'circle-radius': 30, // 誤差の範囲（ピクセル指定、実際はもっと曖昧）
                'circle-color': '#007bff',
                'circle-opacity': 0.3,
                'circle-stroke-width': 2,
                'circle-stroke-color': '#007bff'
            }
        });
        updateRouteList();
    });

    // --- メニュー開閉 ---
    function toggleMenu() {
        document.getElementById('side-menu').classList.toggle('open');
    }

    // --- 追従モード（精度制限あり） ---
    function toggleTracking() {
        isTracking = !isTracking;
        const btn = document.getElementById('trackBtn');
        btn.classList.toggle('active', isTracking);
        btn.innerText = `追従モード: ${isTracking ? 'ON' : 'OFF'}`;
        document.getElementById('nav-info').style.display = isTracking ? 'block' : 'none';

        if (isTracking) {
            // enableHighAccuracy: false でバッテリー消費と精度を抑える
            watchId = navigator.geolocation.watchPosition(updatePosition, null, { enableHighAccuracy: false });
            toggleMenu(); // メニューを閉じる
        } else {
            if (watchId) navigator.geolocation.clearWatch(watchId);
        }
    }

    function updatePosition(pos) {
        const { latitude, longitude } = pos.coords;
        const coords = [longitude, latitude];
        
        // あえて少しだけ座標をぼかす処理（0.0001度 ≒ 約10mのランダム誤差）
        const fuzzyCoords = [
            longitude + (Math.random() - 0.5) * 0.0002,
            latitude + (Math.random() - 0.5) * 0.0002
        ];

        map.getSource('user-pos').setData({ type: 'Point', coordinates: fuzzyCoords });
        if (isTracking) map.easeTo({ center: fuzzyCoords });

        if (currentRoute.length > 0) {
            const dest = currentRoute[currentRoute.length - 1];
            document.getElementById('distance').innerText = calculateDistance(longitude, latitude, dest[0], dest[1]);
        }
    }

    // --- モード切替 ---
    function toggleMode(m) {
        mode = (mode === m) ? 'none' : m;
        document.getElementById('drawModeBtn').classList.toggle('active', mode === 'draw');
        document.getElementById('autoModeBtn').classList.toggle('active', mode === 'auto');
        if (mode !== 'none') toggleMenu();
        if (mode === 'draw') map.dragPan.disable(); else map.dragPan.enable();
    }

    // --- ルート作成（なぞり & クリック） ---
    map.on('mousemove', (e) => {
        if (mode !== 'draw') return;
        currentRoute.push([e.lngLat.lng, e.lngLat.lat]);
        updateMapLine();
    });

    map.on('click', async (e) => {
        if (mode !== 'auto') return;
        const coords = [e.lngLat.lng, e.lngLat.lat];
        if (currentRoute.length > 0) {
            const start = currentRoute[currentRoute.length - 1];
            const url = `https://router.project-osrm.org/route/v1/walking/${start[0]},${start[1]};${coords[0]},${coords[1]}?overview=full&geometries=geojson`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.routes[0]) currentRoute = currentRoute.concat(data.routes[0].geometry.coordinates);
        } else {
            currentRoute.push(coords);
        }
        updateMapLine();
    });

    function updateMapLine() {
        map.getSource('route').setData({ type: 'Feature', geometry: { type: 'LineString', coordinates: currentRoute } });
    }

    // --- 保存・読み込み ---
    function saveCurrentRoute() {
        const name = prompt("ルート名を入力", "マイルート " + new Date().toLocaleTimeString());
        if (!name) return;
        const saved = JSON.parse(localStorage.getItem('my_routes') || '[]');
        saved.push({ name, data: currentRoute });
        localStorage.setItem('my_routes', JSON.stringify(saved));
        updateRouteList();
    }

    function updateRouteList() {
        const list = document.getElementById('route-list');
        list.innerHTML = '';
        JSON.parse(localStorage.getItem('my_routes') || '[]').forEach((r, i) => {
            const item = document.createElement('div');
            item.className = 'route-item';
            item.innerHTML = `<span>${r.name}</span><button onclick="loadRoute(${i})" style="width:50px; padding:5px;">表示</button>`;
            list.appendChild(item);
        });
    }

    function loadRoute(i) {
        currentRoute = JSON.parse(localStorage.getItem('my_routes'))[i].data;
        updateMapLine();
        map.flyTo({ center: currentRoute[0] });
        toggleMenu();
    }

    function clearMap() {
        if (confirm("全てのデータをクリアしますか？")) {
            localStorage.clear();
            location.reload();
        }
    }

    function calculateDistance(lon1, lat1, lon2, lat2) {
        const R = 6371;
        const dLat = (lat2-lat1)*Math.PI/180;
        const dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        const d = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return d > 1 ? d.toFixed(1)+"km" : (d*1000).toFixed(0)+"m";
    }

    function openGoogleMaps() {
        const c = map.getCenter();
        window.open(`https://www.google.com/maps/@${c.lat},${c.lng},15z`);
    }
</script>
</body>
</html>
